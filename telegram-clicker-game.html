<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Clicker Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1E1E1E;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .score {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .clicker-button {
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
            margin-bottom: 30px;
        }
        
        .clicker-button:active {
            transform: scale(0.95);
        }
        
        .clicker-button img {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
        }
        
        .leaderboard {
            background-color: #2C2C2C;
            border-radius: 10px;
            padding: 20px;
            width: 100%;
        }
        
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        
        .leaderboard-rank {
            width: 10%;
        }
        
        .leaderboard-name {
            width: 60%;
            text-align: left;
        }
        
        .leaderboard-score {
            width: 30%;
            text-align: right;
        }
        
        .login-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .login-button {
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .login-button img {
            width: 24px;
            height: 24px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Telegram Clicker</h1>
        </div>
        
        <div id="login-area" class="login-area">
            <p>Войдите с помощью Telegram, чтобы начать игру и сохранить свой прогресс</p>
            <button id="login-button" class="login-button">
                <img src="https://telegram.org/img/t_logo.svg" alt="Telegram Logo">
                Войти через Telegram
            </button>
        </div>
        
        <div id="game-area" class="game-area hidden">
            <div class="score">
                Счет: <span id="score-value">0</span>
            </div>
            
            <a href="#" class="clicker-button" id="clicker">
                <img src="https://via.placeholder.com/200" alt="Click Me!">
            </a>
            
            <div id="user-info"></div>
        </div>
        
        <div class="leaderboard">
            <h2>Таблица лидеров</h2>
            <div class="leaderboard-header">
                <div class="leaderboard-rank">Место</div>
                <div class="leaderboard-name">Игрок</div>
                <div class="leaderboard-score">Счет</div>
            </div>
            <div id="leaderboard-list">
                <!-- Leaderboard items will be added here -->
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tgWebApp = window.Telegram.WebApp;
        tgWebApp.expand();
        
        // Переменные для игры
        let score = 0;
        let userId = null;
        let userName = null;
        let isAuthenticated = false;
        
        // DOM элементы
        const loginArea = document.getElementById('login-area');
        const gameArea = document.getElementById('game-area');
        const loginButton = document.getElementById('login-button');
        const clickerButton = document.getElementById('clicker');
        const scoreValue = document.getElementById('score-value');
        const userInfo = document.getElementById('user-info');
        const leaderboardList = document.getElementById('leaderboard-list');
        
        // Mock leaderboard data - в реальном приложении данные будут приходить с сервера
        let leaderboardData = [
            { rank: 1, name: "Игрок 1", score: 5432 },
            { rank: 2, name: "Игрок 2", score: 4321 },
            { rank: 3, name: "Игрок 3", score: 3210 },
            { rank: 4, name: "Игрок 4", score: 2109 },
            { rank: 5, name: "Игрок 5", score: 1098 }
        ];
        
        // Функция для авторизации через Telegram
        function authenticateWithTelegram() {
            if (tgWebApp.initDataUnsafe && tgWebApp.initDataUnsafe.user) {
                // Пользователь уже авторизован в Telegram WebApp
                const user = tgWebApp.initDataUnsafe.user;
                userId = user.id;
                userName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                
                isAuthenticated = true;
                loginArea.classList.add('hidden');
                gameArea.classList.remove('hidden');
                userInfo.textContent = `Привет, ${userName}!`;
                
                // В реальном приложении здесь будет загрузка сохраненного счета
                loadUserScore();
            } else {
                // Для тестирования за пределами Telegram можно использовать имитацию входа
                // В реальном приложении нужно перенаправить на авторизацию Telegram
                tgWebApp.showPopup({
                    title: 'Авторизация',
                    message: 'Для игры используйте Telegram WebApp в Telegram',
                    buttons: [{ text: 'OK' }]
                });
            }
        }
        
        // Инициализация Web3 для взаимодействия с блокчейном
        async function initWeb3() {
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.enable();
                    console.log("Web3 initialized");
                    // Здесь может быть код для взаимодействия с смарт-контрактом
                } catch (error) {
                    console.error("User denied account access");
                }
            } else if (window.web3) {
                window.web3 = new Web3(window.web3.currentProvider);
                console.log("Legacy web3 detected");
            } else {
                console.log("No web3 detected");
            }
        }
        
        // Загрузка счета пользователя (в реальном приложении с сервера)
        function loadUserScore() {
            // Имитация загрузки счета с сервера
            setTimeout(() => {
                // В реальном приложении здесь будет запрос к API
                const savedScore = localStorage.getItem(`score_${userId}`);
                if (savedScore) {
                    score = parseInt(savedScore);
                    scoreValue.textContent = score;
                }
                
                // Проверяем, есть ли пользователь в таблице лидеров
                updateLeaderboard();
            }, 500);
        }
        
        // Сохранение счета пользователя
        function saveUserScore() {
            // В реальном приложении здесь будет отправка на сервер
            localStorage.setItem(`score_${userId}`, score);
            
            // Проверяем, достаточно ли у пользователя очков для таблицы лидеров
            updateLeaderboard();
        }
        
        // Обновление таблицы лидеров
        function updateLeaderboard() {
            // Проверяем, достаточно ли у пользователя очков для таблицы лидеров
            if (isAuthenticated) {
                const userInLeaderboard = leaderboardData.find(item => item.name === userName);
                
                if (userInLeaderboard) {
                    // Обновляем счет пользователя, если он уже в таблице
                    if (score > userInLeaderboard.score) {
                        userInLeaderboard.score = score;
                        leaderboardData.sort((a, b) => b.score - a.score);
                        
                        // Обновляем ранги
                        leaderboardData.forEach((item, index) => {
                            item.rank = index + 1;
                        });
                    }
                } else if (leaderboardData.length < 100 || score > leaderboardData[leaderboardData.length - 1].score) {
                    // Добавляем пользователя в таблицу, если его счет выше последнего или ещё есть место
                    leaderboardData.push({ name: userName, score: score });
                    leaderboardData.sort((a, b) => b.score - a.score);
                    
                    // Обновляем ранги и обрезаем до 100 записей
                    leaderboardData.forEach((item, index) => {
                        item.rank = index + 1;
                    });
                    
                    if (leaderboardData.length > 100) {
                        leaderboardData = leaderboardData.slice(0, 100);
                    }
                }
            }
            
            // Обновляем отображение таблицы лидеров
            leaderboardList.innerHTML = '';
            leaderboardData.slice(0, 10).forEach(item => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                const rankElement = document.createElement('div');
                rankElement.className = 'leaderboard-rank';
                rankElement.textContent = item.rank;
                
                const nameElement = document.createElement('div');
                nameElement.className = 'leaderboard-name';
                nameElement.textContent = item.name;
                
                const scoreElement = document.createElement('div');
                scoreElement.className = 'leaderboard-score';
                scoreElement.textContent = item.score;
                
                leaderboardItem.appendChild(rankElement);
                leaderboardItem.appendChild(nameElement);
                leaderboardItem.appendChild(scoreElement);
                
                // Выделение текущего пользователя
                if (isAuthenticated && item.name === userName) {
                    leaderboardItem.style.backgroundColor = 'rgba(0, 136, 204, 0.2)';
                    leaderboardItem.style.borderRadius = '5px';
                }
                
                leaderboardList.appendChild(leaderboardItem);
            });
        }
        
        // Обработчик нажатия на кнопку
        clickerButton.addEventListener('click', (e) => {
            e.preventDefault();
            
            if (!isAuthenticated) {
                authenticateWithTelegram();
                return;
            }
            
            score++;
            scoreValue.textContent = score;
            
            // Эффект нажатия
            clickerButton.style.transform = 'scale(0.95)';
            setTimeout(() => {
                clickerButton.style.transform = 'scale(1)';
            }, 100);
            
            // Сохраняем счет каждые 5 кликов
            if (score % 5 === 0) {
                saveUserScore();
            }
        });
        
        // Обработчик нажатия на кнопку авторизации
        loginButton.addEventListener('click', () => {
            authenticateWithTelegram();
        });
        
        // Инициализация приложения
        window.addEventListener('load', async () => {
            // Инициализация Web3
            await initWeb3();
            
            // Первоначальное обновление таблицы лидеров
            updateLeaderboard();
            
            // Проверка авторизации при загрузке
            if (tgWebApp.initDataUnsafe && tgWebApp.initDataUnsafe.user) {
                authenticateWithTelegram();
            }
        });
    </script>
</body>
</html>
